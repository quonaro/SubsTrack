name: CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    outputs:
      build_error: ${{ steps.check_build_error.outputs.error_msg }}
    
    services:
      db:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: substrack_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Set up uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true
      
    - name: Install dependencies
      working-directory: ./backend
      run: |
        uv sync --frozen
        
    - name: Lint with Ruff
      working-directory: ./backend
      run: |
        uv run ruff check .
        
    # Add tests here when available
    
    - name: Build Frontend
      working-directory: ./frontend
      run: |
        npm install 2> ../error.log
        npm run build 2>> ../error.log
        
    - name: Check for build error
      id: check_build_error
      if: failure()
      run: |
        if [ -f error.log ]; then
          ERROR_MSG=$(tail -n 10 error.log | sed 's/\"/\\\"/g')
          echo "error_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$ERROR_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "error_msg=Unknown build error" >> $GITHUB_OUTPUT
        fi
        


  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    outputs:
      deploy_error: ${{ steps.deploy.outputs.error_msg }}
    
    steps:
    - name: Deploy to Server
      id: deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          # Capture output of commands
          exec 2>&1
          {
            # Install nest
            curl -fsSL https://raw.githubusercontent.com/quonaro/nest/main/install.static.sh | bash
            
            cd ${{ secrets.PROJECT_PATH }}
            git pull origin main || git pull origin master
            
            # Run application using nest
            export PATH="${HOME}/.local/bin:${PATH}"
            nest app run && nest db upgrade && sleep 10 && nest app prod run
          } || {
            echo "DEPLOY_FAILED"
            exit 1
          }


  notify:
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy]
    if: always()
    steps:
      - name: Send Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_ADMIN_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            üöÄ *Workflow:* ${{ github.workflow }}
            –°—Ç–∞—Ç—É—Å: ${{ (needs.build-and-test.result == 'success' && (needs.deploy.result == 'success' || needs.deploy.result == 'skipped')) && '‚úÖ *SUCCESS*' || '‚ùå *FAILED*' }}
            
            *Build & Test:* ${{ needs.build-and-test.result }}
            *Deploy:* ${{ needs.deploy.result }}
            
            ${{ needs.build-and-test.result == 'failure' && format('‚ö†Ô∏è *Build Error:*\n```bash\n{0}\n```', needs.build-and-test.outputs.build_error) || '' }}
            ${{ needs.deploy.result == 'failure' && '‚ö†Ô∏è *Deploy Error:*\n```bash\nCheck GitHub Actions logs for SSH details\n```' || '' }}
            
            *Commit:* `${{ github.event.head_commit.message }}`
            *Author:* ${{ github.actor }}
            *Link:* [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
