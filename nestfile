@function psql_query(query: str, !host|H: str = "$DB_HOST"):
    > script: |
        psql -U "$POSTGRES_USER" -h "{{host}}" -p "$POSTGRES_PORT" -d "$POSTGRES_DB" -c "{{query}}"
db:
    > desc: Database commands
    > env: .env
    > env: PGPASSWORD=$POSTGRES_PASSWORD
    > env: POSTGRES_PORT=5432
    backup(!backup_path|p: str = "./backups", !host|H: str = "$DB_HOST"):
        @var filename = $(date -u +"%Y-%m-%d_%H-%M-%S")_$POSTGRES_DB.sql
        > desc: Backup database
        > before: echo "ðŸ”„ Backuping database $POSTGRES_DB to {{backup_path}}/{{filename}}"
        > after: echo "âœ… Backuped database $POSTGRES_DB to {{backup_path}}/{{filename}}"
        > script: |
            pg_dump -U "$POSTGRES_USER" -h "{{host}}" -p "$POSTGRES_PORT" -d "$POSTGRES_DB" -f "{{backup_path}}/{{filename}}"
    restore(backup_file: str, !host|H: str = $DB_HOST, !force:bool = false):
        > desc: Restore database
        > if: {{force}} == "false"
        > before: echo "ðŸ”„ Restoring database $POSTGRES_DB from {{backup_file}}"
        > script: |
            # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ…ÐµÐ¼Ñ‹ Ñ‡ÐµÑ€ÐµÐ· Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ
            psql_query(host="{{host}}", query="DO \$\$ ... (Ð²ÐµÑÑŒ Ð²Ð°Ñˆ SQL Ð±Ð»Ð¾Ðº) ... \$\$;")
            # Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
            psql -U "$POSTGRES_USER" -h "{{host}}" -p "$POSTGRES_PORT" -d "$POSTGRES_DB" -f "{{backup_file}}"
        > else:
        > script: |
            # Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹ Ð¸ Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð‘Ð” Ñ‡ÐµÑ€ÐµÐ· psql Ðº Ð±Ð°Ð·Ðµ 'postgres'
            PGDATABASE=postgres psql_query(host="{{host}}", query="SELECT pg_terminate_backend(pid)...; DROP DATABASE...; CREATE DATABASE...;")
            # Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
            psql -U "$POSTGRES_USER" -h "{{host}}" -p "$POSTGRES_PORT" -d "$POSTGRES_DB" -f "{{backup_file}}"
        > after: echo "âœ… Restored database $POSTGRES_DB from {{backup_file}}"
                            
    list(!backup_path|p: str = "./backups"):
        > desc: List database backups
        > script: find {{backup_path}} -maxdepth 1 -type f -name "*.sql" -printf '%T@ %TY-%Tm-%Td %TH:%TM | %f\n' | sort -nr | cut -d' ' -f2-
    migrate():
        > desc: Migrations with Aerich (Dev Mode)
        > if: $DEV == true
        > script: PYTHONPATH=./src uv run aerich migrate 2>/dev/null
        > else: echo "Skipping migrations (DEV != true)"
        > fallback: echo "Not found migrations"
        
    upgrade(type: str = "dev"):
        > desc: Upgrade with Aerich
        > cwd: backend
        > script: uv run aerich upgrade
app(type: str = "dev"):
    > desc: Control Application
    > env: .env
    > env: DC=docker compose -f {{type}}.yml
    logs(*):
        > desc: Logs Application
        > script: $DC logs {{*}}
    list:
        > desc: List Application
        > script: $DC config --services
    run(!build:bool=true, !include: arr = [] ):
        > desc: Run Application (prod | dev)
        > script: $DC up {{include}} -d "{{build|copy}}" --force-recreate
    down:
        > desc: Down Services
        > script: $DC down 
    exec(app: str, *commands):
        > desc: Execute commands in Container
        > script: $DC exec "{{app}}" {{*commands}}